# GitHub Actions Workflow for deploying to Alibaba Cloud Function Compute
name: Deploy to Alibaba Cloud FC

# This workflow runs on every push to the 'main' branch
on:
    push:
        branches:
            - main

jobs:
    deploy-function:
        runs-on: ubuntu-latest # Use the latest available runner

        steps:
            # 1. Checks out your repository code
            - name: Checkout Code
              uses: actions/checkout@v4

            # 2. Sets up Node.js environment
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18" # Must match the runtime in your s.yaml

            # 3. Install Serverless Devs CLI
            - name: Install Serverless Devs
              run: npm install @serverless-devs/s -g

            - name: Debug Secrets
              run: |
                  if [ -z "${{ secrets.ALIYUN_ACCESS_KEY_ID }}" ]; then
                  echo "ALIYUN_ACCESS_KEY secret is NOT set."
                  else
                  echo "ALIYUN_ACCESS_KEY secret is set."
                  fi
                  if [ -z "${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}" ]; then
                  echo "ALIYUN_SECRET_KEY secret is NOT set."
                  else
                  echo "ALIYUN_SECRET_KEY secret is set."
                  fi

            # 4. Configure Serverless Devs with credentials from GitHub Secrets
            - name: Configure Credentials
              run: s config add --AccessKeyID ${{ secrets.ALIYUN_ACCESS_KEY_ID }} --AccessKeySecret ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }} -a default -f

            # 5. Deploy the function
            - name: Deploy Function
              # We pass the secrets as environment variables so s.yaml can access them
              run: s deploy --use-local -y
              env:
                  ALIYUN_ACCESS_KEY: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
                  ALIYUN_SECRET_KEY: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
                  MNS_ACCOUNT_ID: ${{ secrets.MNS_ACCOUNT_ID }}
