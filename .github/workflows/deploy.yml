# GitHub Actions Workflow for deploying to Alibaba Cloud Function Compute
name: Deploy to Alibaba Cloud FC

# This workflow runs on every push to the 'main' branch
on:
    push:
        branches:
            - main

jobs:
    deploy-function:
        runs-on: ubuntu-latest # Use the latest available runner

        steps:
            # 1. Checks out your repository code
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Populate s.yaml with secrets
              run: |
                  sed -i "s|ACCESS_KEY_ID_PLACEHOLDER|${{ secrets.ALIYUN_ACCESS_KEY_ID }}|g" s.yaml
                  sed -i "s|ACCESS_KEY_SECRET_PLACEHOLDER|${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}|g" s.yaml
                  sed -i "s|MNS_ACCOUNT_ID_PLACEHOLDER|${{ secrets.MNS_ACCOUNT_ID }}|g" s.yaml
                  sed -i "s|MNS_QUEUE_NAME_PLACEHOLDER|${{ secrets.MNS_QUEUE_NAME }}|g" s.yaml
                  sed -i "s|FCM_CREDENTIALS_JSON_PLACEHOLDER|${{ secrets.FCM_CREDENTIALS_JSON }}|g" s.yaml
                  sed -i "s|MONGO_URI_PLACEHOLDER|${{ secrets.MONGO_URI }}|g" s.yaml
                  sed -i "s|MONGO_DBNAME_PLACEHOLDER|${{ secrets.MONGO_DBNAME }}|g" s.yaml

            # (Optional) You can add this step to see the final s.yaml file
            - name: Verify populated s.yaml
              run: cat s.yaml

            # 2. Sets up Node.js environment
            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "18" # Must match the runtime in your s.yaml

            # 3. Install Serverless Devs CLI
            - name: Install Serverless Devs
              run: npm install @serverless-devs/s -g

            # 4. Configure Serverless Devs with credentials from GitHub Secrets
            - name: Configure Credentials
              run: s config add --AccessKeyID ${{ secrets.ALIYUN_ACCESS_KEY_ID }} --AccessKeySecret ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }} -a default -f

            - name: Get Aliyun Authorization Token
              id: get_token
              run: |
                  echo "ACCESS_KEY_ID=${{ secrets.ALIYUN_ACCESS_KEY_ID }}"
                  echo "ACCESS_KEY_SECRET=${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}"
                  echo "ALI_BABA_REGION=${{ secrets.ALIYUN_REGION }}"
                  echo "CR_INSTANCE_ID=${{ secrets.ALIYUN_CR_INSTANCE_ID }}"

            # 5. Deploy the function
            - name: Deploy Function
              # We pass the secrets as environment variables so s.yaml can access them
              run: s deploy --use-local -y
